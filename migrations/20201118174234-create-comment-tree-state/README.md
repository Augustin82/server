# Migration `20201118174234-create-comment-tree-state`

This migration has been generated by Giorgio Delgado at 11/18/2020, 12:42:34 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "admins" (
    "id" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "username" TEXT NOT NULL,
    "password" TEXT NOT NULL,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "sites" (
    "id" TEXT NOT NULL,
    "hostname" TEXT NOT NULL,
    "verified" BOOLEAN NOT NULL DEFAULT false,
    "dns_tag" TEXT NOT NULL,
    "admin_id" TEXT NOT NULL,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "users" (
    "id" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "username" TEXT NOT NULL,
    "password" TEXT NOT NULL,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "comments" (
    "id" TEXT NOT NULL,
    "anon_author_name" TEXT,
    "body" TEXT NOT NULL DEFAULT E'',
    "votes" INTEGER NOT NULL DEFAULT 0,
    "post_id" TEXT NOT NULL,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL,
    "parent_comment_id" TEXT,
    "author_id" TEXT,

    PRIMARY KEY ("id")
)

CREATE TABLE "comment_tree_state" (
    "post_id" TEXT NOT NULL,
    "comment_tree_leafs" JSONB NOT NULL,

    PRIMARY KEY ("post_id")
)

CREATE TABLE "posts" (
    "id" TEXT NOT NULL,
    "url_slug" TEXT NOT NULL,
    "site_id" TEXT NOT NULL,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL,

    PRIMARY KEY ("id")
)

CREATE UNIQUE INDEX "admins.email_unique" ON "admins"("email")

CREATE UNIQUE INDEX "admins.username_unique" ON "admins"("username")

CREATE UNIQUE INDEX "sites.hostname_unique" ON "sites"("hostname")

CREATE UNIQUE INDEX "sites.dns_tag_unique" ON "sites"("dns_tag")

CREATE UNIQUE INDEX "users.email_unique" ON "users"("email")

CREATE UNIQUE INDEX "users.username_unique" ON "users"("username")

CREATE UNIQUE INDEX "posts.url_slug_unique" ON "posts"("url_slug")

ALTER TABLE "sites" ADD FOREIGN KEY("admin_id")REFERENCES "admins"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "comments" ADD FOREIGN KEY("parent_comment_id")REFERENCES "comments"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "comments" ADD FOREIGN KEY("author_id")REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "comments" ADD FOREIGN KEY("post_id")REFERENCES "posts"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "comment_tree_state" ADD FOREIGN KEY("post_id")REFERENCES "posts"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "posts" ADD FOREIGN KEY("site_id")REFERENCES "sites"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201117215345-create-tree-structure-for-comments..20201118174234-create-comment-tree-state
--- datamodel.dml
+++ datamodel.dml
@@ -1,9 +1,9 @@
 // https://pris.ly/d/prisma-schema
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
@@ -65,8 +65,18 @@
   parent_comment_id String?
   author_id         String?
 }
+
+// Tracks the state of the leaf nodes on a per-post basis
+model CommentTreeState {
+  @@map("comment_tree_state")
+  post               Post @relation(fields: [post_id], references: [id])
+  post_id            String @id
+  comment_tree_leafs Json // ["123", "345", "545"]
+}
+
+
 model Post {
   id         String    @id @default(cuid())
   url_slug   String    @unique
   site       Site      @relation(fields: [site_id], references: [id])
```


