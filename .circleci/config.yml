version: 2.1
jobs:
  build:
    machine:
      docker_layer_caching: true

    steps:
      - checkout

      - add_ssh_keys:
          fingerprints:
            - "29:f8:00:46:76:04:2d:f9:ed:a5:ca:d8:66:ab:eb:7d"

      - run:
          name: Set up docker
          command: echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin

      - run:
          name: Build and push image
          command: |
            docker build -t parlezvous/server:$CIRCLE_SHA1 --compress .
            docker push parlezvous/server:$CIRCLE_SHA1
            ssh -p $SSH_PORT deploy@$SERVER "cd repo && ./deploy/run.sh $CIRCLE_BRANCH"
